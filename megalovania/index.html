<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Megalovania - Synth Engine</title>

<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>

<style>
body {
  background: black;
  color: white;
  font-family: monospace;
  text-align: center;
  padding-top: 60px;
}
button {
  font-size: 20px;
  padding: 15px 30px;
  cursor: pointer;
}
canvas {
  margin-top: 40px;
}
</style>
</head>
<body>

<button id="startButton">Play Megalovania</button>
<br>
<canvas id="sansCanvas" width="400" height="400"></canvas>

<script>
// =======================
// CANVAS + SANS ANIMATION
// =======================

const canvas = document.getElementById("sansCanvas");
const ctx = canvas.getContext("2d");

const img = new Image();
img.src = "sans-fight.gif"; // must be in same folder

let swayAngle = 0;

img.onload = () => {
  animate();
};

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2 + 40;

  const swayX = Math.sin(swayAngle) * 8;
  swayAngle += 0.08;

  ctx.drawImage(
    img,
    centerX - img.width / 2 + swayX,
    centerY - img.height / 2
  );

  requestAnimationFrame(animate);
}

// =======================
// TONE.JS MIDI PLAYER
// =======================

const startButton = document.getElementById("startButton");
let midiLoaded = false;
let midiData;

const synth = new Tone.PolySynth(Tone.Synth, {
  oscillator: {
    type: "square"
  },
  envelope: {
    attack: 0.005,
    decay: 0.1,
    sustain: 0.3,
    release: 0.1
  }
}).toDestination();

async function loadMidi() {
  const response = await fetch("UNDERTALE - MEGALOVANIA.mid");
  const arrayBuffer = await response.arrayBuffer();
  midiData = new Midi(arrayBuffer);
  midiLoaded = true;
}

startButton.addEventListener("click", async () => {

  await Tone.start();

  if (!midiLoaded) {
    await loadMidi();
  }

  Tone.Transport.cancel();
  Tone.Transport.stop();
  Tone.Transport.position = 0;

  midiData.tracks.forEach(track => {
    track.notes.forEach(note => {
      Tone.Transport.schedule(time => {
        synth.triggerAttackRelease(
          note.name,
          note.duration,
          time,
          note.velocity
        );
      }, note.time);
    });
  });

  Tone.Transport.loop = true;
  Tone.Transport.loopEnd = midiData.duration;

  Tone.Transport.start();
});
</script>

</body>
</html>