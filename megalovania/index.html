<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Megalovania - Synth Version</title>

<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>

<style>
body {
  background: black;
  color: white;
  font-family: monospace;
  text-align: center;
  padding-top: 100px;
}
button {
  font-size: 20px;
  padding: 15px 30px;
}
</style>
</head>
<body>

<button id="startButton">Play Megalovania (Synth Engine)</button>

<script>

document.getElementById("startButton").addEventListener("click", async () => {

  const button = document.getElementById("startButton");
  button.disabled = true;
  button.innerText = "Starting...";

  await Tone.start();

  // Load MIDI
  const response = await fetch("UNDERTALE - MEGALOVANIA.mid");
  const arrayBuffer = await response.arrayBuffer();
  const midi = new Midi(arrayBuffer);

  // Set tempo
  Tone.Transport.bpm.value = midi.header.tempos.length > 0
    ? midi.header.tempos[0].bpm
    : 120;

  const reverb = new Tone.Reverb({ decay: 1.5, wet: 0.2 }).toDestination();

  function createInstrument(program, channel) {

    // Channel 10 = Drums
    if (channel === 9) {
      return new Tone.MembraneSynth({
        pitchDecay: 0.01,
        octaves: 5,
        envelope: {
          attack: 0.001,
          decay: 0.4,
          sustain: 0
        }
      }).toDestination();
    }

    // GM program categories

    // Distortion / Overdriven Guitar (29–30)
    if (program === 29 || program === 30) {
      return new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "square" },
        envelope: {
          attack: 0.001,
          decay: 0.1,
          sustain: 0.6,
          release: 0.2
        }
      }).connect(reverb);
    }

    // Lead 1 (Square)
    if (program === 80) {
      return new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "square" },
        envelope: {
          attack: 0.001,
          decay: 0.05,
          sustain: 0.5,
          release: 0.1
        }
      }).connect(reverb);
    }

    // Lead 2 (Saw)
    if (program === 81) {
      return new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sawtooth" },
        envelope: {
          attack: 0.001,
          decay: 0.05,
          sustain: 0.5,
          release: 0.1
        }
      }).connect(reverb);
    }

    // Strings / Organs (16–23, 48–55)
    if (
      (program >= 16 && program <= 23) ||
      (program >= 48 && program <= 55)
    ) {
      return new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "square" },
        envelope: {
          attack: 0.02,
          decay: 0.2,
          sustain: 0.7,
          release: 1.2
        }
      }).connect(reverb);
    }

    // Bass (32–39)
    if (program >= 32 && program <= 39) {
      return new Tone.MonoSynth({
        oscillator: { type: "square" },
        filter: { Q: 2, type: "lowpass", rolloff: -24 },
        envelope: {
          attack: 0.01,
          decay: 0.2,
          sustain: 0.4,
          release: 0.2
        }
      }).toDestination();
    }

    // Default fallback = square synth
    return new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: "square" }
    }).connect(reverb);
  }

  const instrumentCache = {};

  midi.tracks.forEach(track => {

    const channel = track.channel;
    const program = track.instrument.number;

    const key = `${channel}-${program}`;

    if (!instrumentCache[key]) {
      instrumentCache[key] = createInstrument(program, channel);
    }

    const instrument = instrumentCache[key];

    track.notes.forEach(note => {

      Tone.Transport.schedule(time => {

        instrument.triggerAttackRelease(
          note.name,
          note.duration,
          time,
          note.velocity
        );

      }, note.time);

    });

  });

  Tone.Transport.start();
  button.innerText = "Playing";

});

</script>

</body>
</html>
